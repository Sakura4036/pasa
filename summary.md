## PaperAgent实现逻辑总结

PaperAgent是一个智能论文搜索和扩展代理，它能够根据用户查询自动搜索相关论文，并通过引用关系扩展搜索范围，构建论文引用树结构。以下是其主要实现逻辑：

### 1. 核心组件

1. **PaperNode类**：
   - 表示论文树中的一个节点
   - 存储论文的基本信息（标题、摘要、arXiv ID等）
   - 管理论文的引用关系（子节点）
   - 提供序列化和排序方法

2. **Agent类**：
   - 封装了语言模型的操作
   - 提供推理方法，生成文本或评分
   - 支持批量推理，提高效率

3. **PaperAgent类**：
   - 实现论文搜索和扩展的核心逻辑
   - 管理搜索和扩展过程
   - 构建论文引用树结构

### 2. 工作流程

1. **初始化阶段**：
   - 设置用户查询、爬虫模型、选择器模型等参数
   - 创建根节点，存储用户查询

2. **搜索阶段**：
   - 使用爬虫模型生成搜索查询
   - 使用Google搜索API查找相关论文
   - 使用选择器模型评估论文相关性
   - 将相关论文添加到根节点的子节点中

3. **扩展阶段**：
   - 从已找到的论文中提取引用关系
   - 搜索引用论文并评估相关性
   - 将相关引用论文添加到原论文的对应章节子节点中
   - 将引用论文添加到待扩展队列中

4. **多轮扩展**：
   - 可以设置多轮扩展，构建更深层次的引用关系树
   - 每轮扩展都从待扩展队列中取出论文进行处理
   - 按相关性评分排序，优先处理相关性高的论文

### 3. 并行处理

- 使用多线程并行处理搜索和扩展操作
- 使用线程锁保护共享资源，避免竞态条件
- 提供静态方法do_parallel用于并行执行函数

### 4. 数据流

1. 用户查询 → 搜索查询 → 论文列表 → 相关性评分 → 论文节点
2. 论文节点 → 章节内容 → 引用列表 → 引用论文 → 相关性评分 → 引用论文节点
3. 引用论文节点 → 待扩展队列 → 下一轮扩展

### 5. 关键算法

1. **搜索算法**：
   - 使用Google搜索API查找相关论文
   - 使用选择器模型评估论文相关性
   - 相关性评分大于0.5的论文被认为是相关的

2. **扩展算法**：
   - 从论文章节中提取引用关系
   - 搜索引用论文并评估相关性
   - 将相关引用论文添加到原论文的对应章节子节点中

3. **排序算法**：
   - 按相关性评分排序，优先处理相关性高的论文
   - 使用PaperNode.sort_paper方法进行排序

### 6. 使用方式

通过run_paper_agent.py脚本使用PaperAgent：

1. 解析命令行参数，设置搜索和扩展参数
2. 初始化爬虫和选择器模型
3. 处理输入文件中的每个查询
4. 创建PaperAgent实例并运行
5. 将结果保存为JSON文件

这个系统通过结合语言模型、搜索API和引用关系，实现了智能的论文搜索和扩展，帮助用户找到与研究主题相关的论文，并了解论文之间的引用关系。
